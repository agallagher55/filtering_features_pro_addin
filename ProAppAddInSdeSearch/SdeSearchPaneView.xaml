<UserControl x:Class="ProAppAddInSdeSearch.SdeSearchPaneView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"   
             xmlns:extensions="clr-namespace:ArcGIS.Desktop.Extensions;assembly=ArcGIS.Desktop.Extensions"
             xmlns:local="clr-namespace:ProAppAddInSdeSearch"
             mc:Ignorable="d" 
             d:DesignHeight="650" d:DesignWidth="340"
             DataContextChanged="OnDataContextChanged">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <extensions:DesignOnlyResourceDictionary Source="pack://application:,,,/ArcGIS.Desktop.Framework;component\Themes\Default.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            <local:InverseBoolConverter x:Key="InverseBool"/>
            <local:NonEmptyStringToVisibilityConverter x:Key="NonEmptyToVis"/>
            <local:GeometryIconPathConverter x:Key="GeomPathConv"/>
            <local:GeometryIconColorConverter x:Key="GeomColorConv"/>

            <!-- â•â•â• Styled ComboBox â•â•â• -->
            <Style x:Key="ThemedComboBox" TargetType="ComboBox">
                <Setter Property="Background" Value="{DynamicResource FieldBg}"/>
                <Setter Property="Foreground" Value="{DynamicResource PrimaryText}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="6,4"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="ComboBox">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                </Grid.ColumnDefinitions>
                                <Border x:Name="Bd" Grid.ColumnSpan="2" Background="{DynamicResource FieldBg}" 
                                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="3"/>
                                <TextBlock Grid.Column="0" Margin="8,4" VerticalAlignment="Center"
                                           Text="{Binding SelectedItem, RelativeSource={RelativeSource TemplatedParent}}" 
                                           Foreground="{DynamicResource PrimaryText}" TextTrimming="CharacterEllipsis"/>
                                <Path Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                      Data="M 0 0 L 4 4 L 8 0 Z" Fill="{DynamicResource Accent}"/>
                                <ToggleButton Grid.ColumnSpan="2" Opacity="0" 
                                              IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"/>
                                <Popup x:Name="PART_Popup" AllowsTransparency="True" Focusable="False"
                                       IsOpen="{TemplateBinding IsDropDownOpen}" PopupAnimation="Slide" Placement="Bottom">
                                    <Border Background="{DynamicResource PanelBg}" BorderBrush="{DynamicResource Accent}" BorderThickness="1"
                                            MaxHeight="{TemplateBinding MaxDropDownHeight}" MinWidth="{TemplateBinding ActualWidth}">
                                        <ScrollViewer><ItemsPresenter/></ScrollViewer>
                                    </Border>
                                </Popup>
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource Accent}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Setter Property="ItemContainerStyle">
                    <Setter.Value>
                        <Style TargetType="ComboBoxItem">
                            <Setter Property="Background" Value="{DynamicResource PanelBg}"/>
                            <Setter Property="Foreground" Value="{DynamicResource PrimaryText}"/>
                            <Setter Property="Padding" Value="8,6"/>
                            <Style.Triggers>
                                <Trigger Property="IsHighlighted" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource Accent}"/>
                                    <Setter Property="Foreground" Value="{DynamicResource AccentText}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- â•â•â• Styled TextBox â•â•â• -->
            <Style x:Key="ThemedTextBox" TargetType="TextBox">
                <Setter Property="Background" Value="{DynamicResource FieldBg}"/>
                <Setter Property="Foreground" Value="{DynamicResource PrimaryText}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="6,4"/>
                <Setter Property="CaretBrush" Value="{DynamicResource Accent}"/>
                <Style.Triggers>
                    <Trigger Property="IsFocused" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource Accent}"/>
                    </Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="ThemedCheckBox" TargetType="CheckBox">
                <Setter Property="Foreground" Value="{DynamicResource SecondaryText}"/>
                <Setter Property="FontSize" Value="11"/><Setter Property="Margin" Value="0,0,10,0"/>
                <Setter Property="VerticalContentAlignment" Value="Center"/>
            </Style>

            <Style x:Key="PrimaryBtn" TargetType="Button">
                <Setter Property="Background" Value="{DynamicResource Accent}"/>
                <Setter Property="Foreground" Value="{DynamicResource AccentText}"/>
                <Setter Property="BorderThickness" Value="0"/><Setter Property="Padding" Value="12,6"/>
                <Setter Property="Cursor" Value="Hand"/><Setter Property="FontWeight" Value="SemiBold"/>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="{DynamicResource AccentHover}"/></Trigger>
                    <Trigger Property="IsEnabled" Value="False"><Setter Property="Background" Value="{DynamicResource BorderBrush}"/><Setter Property="Opacity" Value="0.6"/></Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="SecBtn" TargetType="Button">
                <Setter Property="Background" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource PrimaryText}"/>
                <Setter Property="BorderThickness" Value="0"/><Setter Property="Padding" Value="10,6"/><Setter Property="Cursor" Value="Hand"/>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="{DynamicResource AccentHover}"/><Setter Property="Foreground" Value="{DynamicResource AccentText}"/></Trigger>
                    <Trigger Property="IsEnabled" Value="False"><Setter Property="Opacity" Value="0.4"/></Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="AddMapBtn" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource Accent}"/>
                        <Setter Property="Background" Value="{DynamicResource FieldBg}"/>
                    </Trigger>
                </Style.Triggers>
            </Style>

            <!-- â•â•â• Geometry Icon Template â•â•â• -->
            <DataTemplate x:Key="GeometryIconTemplate">
                <Viewbox Width="20" Height="20" Margin="0,0,8,0">
                    <Path Data="{Binding GeometryIconType, Converter={StaticResource GeomPathConv}}"
                          Fill="{Binding GeometryIconType, Converter={StaticResource GeomColorConv}}"
                          Stretch="Uniform" Width="20" Height="20"/>
                </Viewbox>
            </DataTemplate>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Grid Background="{DynamicResource PanelBg}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/><!-- header -->
            <RowDefinition Height="Auto"/><!-- connection -->
            <RowDefinition Height="Auto"/><!-- search -->
            <RowDefinition Height="Auto"/><!-- show types -->
            <RowDefinition Height="Auto"/><!-- filters -->
            <RowDefinition Height="Auto"/><!-- progress -->
            <RowDefinition Height="*"/>  <!-- content -->
            <RowDefinition Height="Auto"/><!-- status -->
        </Grid.RowDefinitions>

        <!-- â•â•â• HEADER â•â•â• -->
        <Border Grid.Row="0" Background="{DynamicResource Accent}" Padding="12,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="ðŸ”" FontSize="18" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1" Text="SDE Search" FontWeight="Bold" FontSize="15" 
                           VerticalAlignment="Center" Foreground="{DynamicResource AccentText}"/>
                <!-- Theme toggle -->
                <Button Grid.Column="2" Command="{Binding ToggleThemeCommand}" ToolTip="Toggle light/dark mode"
                        Padding="6,4" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,4,0">
                    <TextBlock Text="{Binding ThemeLabel}" FontSize="14" Foreground="{DynamicResource AccentText}"/>
                </Button>
                <Button Grid.Column="3" Command="{Binding RefreshConnectionsCommand}" ToolTip="Refresh connections"
                        Padding="6,4" Background="Transparent" BorderThickness="0" Cursor="Hand">
                    <TextBlock Text="âŸ³" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource AccentText}"/>
                </Button>
            </Grid>
        </Border>

        <!-- â•â•â• CONNECTION â•â•â• -->
        <Border Grid.Row="1" Background="{DynamicResource FieldBg}" Padding="12,8" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <StackPanel>
                <TextBlock Text="DATABASE CONNECTION" FontSize="10" FontWeight="SemiBold" 
                           Foreground="{DynamicResource Accent}" Margin="0,0,0,6"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <ComboBox Grid.Column="0" ItemsSource="{Binding Connections}"
                              SelectedItem="{Binding SelectedConnection, Mode=TwoWay}"
                              Style="{StaticResource ThemedComboBox}" MinHeight="30"/>
                    <Button Grid.Column="1" Command="{Binding ReloadDataCommand}"
                            ToolTip="Reload data from the database, rebuilding the local cache"
                            Style="{StaticResource SecBtn}" Margin="4,0,0,0" Padding="8,4">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="â†»" FontSize="13" FontWeight="Bold" Margin="0,0,4,0"/>
                            <TextBlock Text="Refresh" FontSize="11" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
                <Expander Header="Add connection manually..." Foreground="{DynamicResource SecondaryText}" 
                          FontSize="11" Margin="0,6,0,0" Background="Transparent" BorderThickness="0">
                    <StackPanel Margin="0,6,0,0">
                        <Button Command="{Binding BrowseSdeCommand}" Style="{StaticResource SecBtn}" 
                                HorizontalAlignment="Left" Padding="10,5" Margin="0,0,0,6">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“‚" FontSize="12" Margin="0,0,6,0"/>
                                <TextBlock Text="Browse for .sde file..." FontSize="11"/>
                            </StackPanel>
                        </Button>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding ManualSdePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ThemedTextBox}" MinHeight="26" VerticalContentAlignment="Center"
                                     FontSize="11" ToolTip="Paste path to .sde file" KeyDown="ManualPath_KeyDown"/>
                            <Button Grid.Column="1" Command="{Binding AddManualPathCommand}" Style="{StaticResource PrimaryBtn}"
                                    Margin="4,0,0,0" Padding="8,4">
                                <TextBlock Text="Add" FontSize="11"/>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Expander>
            </StackPanel>
        </Border>

        <!-- â•â•â• SEARCH â•â•â• -->
        <Border Grid.Row="2" Background="{DynamicResource PanelBg}" Padding="12,10" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <StackPanel>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/><ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ThemedTextBox}" MinHeight="30" VerticalContentAlignment="Center" KeyDown="SearchBox_KeyDown"/>
                    <Button Grid.Column="1" Command="{Binding SearchCommand}" Style="{StaticResource PrimaryBtn}" Margin="6,0,0,0" MinHeight="30">
                        <TextBlock Text="Filter"/>
                    </Button>
                    <Button Grid.Column="2" Command="{Binding ClearCommand}" Style="{StaticResource SecBtn}" Margin="4,0,0,0" MinHeight="30">
                        <TextBlock Text="âœ•" FontSize="12"/>
                    </Button>
                </Grid>
                <WrapPanel Margin="0,8,0,0">
                    <CheckBox Content="Name" IsChecked="{Binding SearchByName}" Style="{StaticResource ThemedCheckBox}"/>
                    <CheckBox Content="Metadata" IsChecked="{Binding SearchByMetadata}" Style="{StaticResource ThemedCheckBox}"
                              ToolTip="Search metadata description, summary, tags, and credits"/>
                    <CheckBox Content="Tags" IsChecked="{Binding SearchByTags}" Style="{StaticResource ThemedCheckBox}"
                              ToolTip="Search tags/keywords only"/>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- â•â•â• ITEM TYPE FILTER â•â•â• -->
        <Border Grid.Row="3" Background="{DynamicResource FieldBg}" Padding="12,6"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Type:" Foreground="{DynamicResource SecondaryText}" FontSize="11"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding AvailableItemTypes}"
                          SelectedItem="{Binding SelectedItemType, Mode=TwoWay}"
                          Style="{StaticResource ThemedComboBox}"
                          MinHeight="26"/>
            </Grid>
        </Border>

        <!-- â•â•â• TAG FILTERS â•â•â• -->
        <Border Grid.Row="4" Background="{DynamicResource FieldBg}" Padding="12,6"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <WrapPanel>
                <TextBlock Text="Filters:" Foreground="{DynamicResource SecondaryText}" FontSize="11"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <CheckBox Content="Editor Tracking" IsChecked="{Binding FilterEditorTracking}" Style="{StaticResource ThemedCheckBox}"/>
                <CheckBox Content="Archiving" IsChecked="{Binding FilterArchiving}" Style="{StaticResource ThemedCheckBox}"/>
                <CheckBox Content="Subtypes" IsChecked="{Binding FilterSubtypes}" Style="{StaticResource ThemedCheckBox}"/>
            </WrapPanel>
        </Border>

        <!-- â•â•â• PROGRESS â•â•â• -->
        <Border Grid.Row="5" Background="{DynamicResource PanelBg}" Padding="12,8"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                Visibility="{Binding IsSearching, Converter={StaticResource BoolToVis}}">
            <StackPanel>
                <ProgressBar Height="3" Foreground="{DynamicResource Accent}"
                             Background="{DynamicResource BorderBrush}" BorderThickness="0" Margin="0,0,0,6"
                             IsIndeterminate="{Binding IsProgressDeterminate, Converter={StaticResource InverseBool}}"
                             Value="{Binding ProgressValue}"
                             Maximum="{Binding ProgressMax, FallbackValue=100}"/>
                <TextBlock Text="{Binding ProgressText}" FontSize="11" Foreground="{DynamicResource AccentLight}" TextWrapping="Wrap"/>
            </StackPanel>
        </Border>

        <!-- â•â•â• MAIN CONTENT â•â•â• -->
        <Grid Grid.Row="6">

            <!-- â”€â”€ RESULTS LIST â”€â”€ -->
            <!-- ListView with VirtualizingStackPanel: only renders visible rows, greatly
                 reducing layout cost when hundreds of results are present. The ItemContainerStyle
                 strips all default ListViewItem chrome (selection, focus rect, padding) so the
                 DataTemplate Border controls the full visual appearance. -->
            <ListView ItemsSource="{Binding SearchResults}"
                      Visibility="{Binding ShowResultsList, Converter={StaticResource BoolToVis}}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                      BorderThickness="0" Background="Transparent"
                      HorizontalContentAlignment="Stretch">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <!-- Minimal template: no selection highlight, no focus rect -->
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <ContentPresenter/>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="10,6" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                                Cursor="Hand" MouseLeftButtonUp="ResultItem_Click">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="{DynamicResource PanelBg}"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource FieldBg}"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Geometry vector icon -->
                                    <Viewbox Grid.Column="0" Grid.RowSpan="3" Width="20" Height="20" Margin="0,0,8,0" VerticalAlignment="Center">
                                        <Path Data="{Binding GeometryIconType, Converter={StaticResource GeomPathConv}}"
                                              Fill="{Binding GeometryIconType, Converter={StaticResource GeomColorConv}}"
                                              Stretch="Uniform" Width="20" Height="20"/>
                                    </Viewbox>

                                    <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal">
                                        <TextBlock Text="{Binding SimpleName}"
                                                   Foreground="{DynamicResource PrimaryText}" FontSize="12" FontWeight="SemiBold"
                                                   TextTrimming="CharacterEllipsis" ToolTip="{Binding Name}"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,1,0,0">
                                        <TextBlock Text="{Binding Subtitle}" Foreground="{DynamicResource SecondaryText}"
                                                   FontSize="10" TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>

                                    <!-- Badges row: Feature dataset + flags -->
                                    <WrapPanel Grid.Column="1" Grid.Row="2" Grid.ColumnSpan="2" Margin="0,3,0,0"
                                               Visibility="{Binding HasBadges, Converter={StaticResource BoolToVis}}">
                                        <!-- Feature Dataset badge -->
                                        <Border CornerRadius="3" Padding="5,1" Margin="0,0,4,0"
                                                Background="#33FFC107"
                                                Visibility="{Binding FeatureDatasetSimpleName, Converter={StaticResource NonEmptyToVis}}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#x1F4C2;" FontSize="9" VerticalAlignment="Center" Margin="0,0,3,0"/>
                                                <TextBlock Text="{Binding FeatureDatasetSimpleName}" FontSize="9" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource AccentLight}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>
                                        <!-- Editor Tracking badge -->
                                        <Border CornerRadius="3" Padding="5,1" Margin="0,0,4,0"
                                                Background="#332196F3"
                                                Visibility="{Binding HasEditorTracking, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="Editor Tracking" FontSize="9"
                                                       Foreground="#64B5F6" VerticalAlignment="Center"/>
                                        </Border>
                                        <!-- Archiving badge -->
                                        <Border CornerRadius="3" Padding="5,1" Margin="0,0,4,0"
                                                Background="#33AB47BC"
                                                Visibility="{Binding IsArchived, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="Archiving" FontSize="9"
                                                       Foreground="#CE93D8" VerticalAlignment="Center"/>
                                        </Border>
                                        <!-- Subtypes badge -->
                                        <Border CornerRadius="3" Padding="5,1" Margin="0,0,4,0"
                                                Background="#33FF7043"
                                                Visibility="{Binding HasSubtypes, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="Subtypes" FontSize="9"
                                                       Foreground="#FF8A65" VerticalAlignment="Center"/>
                                        </Border>
                                    </WrapPanel>

                                    <Button Grid.Column="2" Grid.Row="0" Grid.RowSpan="2"
                                            Visibility="{Binding CanAddToMap, Converter={StaticResource BoolToVis}}"
                                            ToolTip="Add to active map" Padding="4,3" Margin="6,0,0,0"
                                            VerticalAlignment="Center" Click="AddToMapButton_Click"
                                            Style="{StaticResource AddMapBtn}">
                                        <TextBlock Text="ï¼‹" FontSize="14" Foreground="{DynamicResource Accent}"/>
                                    </Button>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            
            <!-- â”€â”€ DETAIL VIEW â”€â”€ -->
            <!-- â”€â”€ SEED CACHE INFO â”€â”€ -->
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Visibility="{Binding ShowSeedCacheInfo, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <!-- Header -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,10"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" Command="{Binding BackToResultsCommand}"
                                    Style="{StaticResource SecBtn}" Margin="0,0,8,0" Padding="8,4">
                                <TextBlock Text="â—€ Back" FontSize="11"/>
                            </Button>
                            <TextBlock Grid.Column="1" Text="SEED CACHE INFO" FontSize="10" FontWeight="SemiBold"
                                       Foreground="{DynamicResource Accent}" VerticalAlignment="Center"/>
                        </Grid>
                    </Border>
                    <!-- Generated from -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,8" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="GENERATED FROM" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource Accent}"/>
                    </Border>
                    <Border Background="{DynamicResource PanelBg}" Padding="12,8"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="{Binding SeedCacheConnectionPath}" Foreground="{DynamicResource PrimaryText}"
                                   FontSize="11" TextWrapping="Wrap"/>
                    </Border>
                    <!-- Generated on -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,8" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="GENERATED ON" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource Accent}"/>
                    </Border>
                    <Border Background="{DynamicResource PanelBg}" Padding="12,8"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="{Binding SeedCacheCachedAt}" Foreground="{DynamicResource PrimaryText}" FontSize="11"/>
                    </Border>
                    <!-- Contents -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,8" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="CONTENTS" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource Accent}"/>
                    </Border>
                    <Border Background="{DynamicResource PanelBg}" Padding="12,8"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="{Binding SeedCacheSummary}" Foreground="{DynamicResource PrimaryText}"
                                   FontSize="11" LineHeight="20"/>
                    </Border>
                    <!-- Notice -->
                    <Border Background="{DynamicResource PanelBg}" Padding="12,10" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Foreground="{DynamicResource AccentLight}" FontSize="11" TextWrapping="Wrap">
                            This is template data. Click &#x21BB; next to the connection selector to reload from your own database.
                        </TextBlock>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <ScrollViewer VerticalScrollBarVisibility="Auto" Visibility="{Binding ShowDetails, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <!-- Header -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,10"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Button Grid.Column="0" Command="{Binding BackToResultsCommand}" Style="{StaticResource SecBtn}" Margin="0,0,8,0" Padding="8,4">
                                    <TextBlock Text="â—€ Back" FontSize="11"/>
                                </Button>
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding SelectedResult.SimpleName}" FontSize="14" FontWeight="Bold" 
                                               Foreground="{DynamicResource PrimaryText}" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding SelectedResult.Subtitle}" FontSize="11" Foreground="{DynamicResource SecondaryText}"/>
                                </StackPanel>
                                <Button Grid.Column="2" Command="{Binding CopyPathCommand}" Style="{StaticResource SecBtn}" Margin="4,0" Padding="8,4" ToolTip="Copy path">
                                    <TextBlock Text="ðŸ“‹" FontSize="12"/>
                                </Button>
                                <Button Grid.Column="3" Command="{Binding AddToMapCommand}" Style="{StaticResource PrimaryBtn}" Padding="8,4"
                                        Visibility="{Binding SelectedResult.CanAddToMap, Converter={StaticResource BoolToVis}}">
                                    <TextBlock Text="ï¼‹ Map" FontSize="11"/>
                                </Button>
                            </Grid>
                            <ProgressBar IsIndeterminate="True" Height="2" Foreground="{DynamicResource Accent}" 
                                         Background="Transparent" BorderThickness="0" Margin="0,6,0,0"
                                         Visibility="{Binding IsLoadingDetails, Converter={StaticResource BoolToVis}}"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Metadata -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,8" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="METADATA" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource Accent}"/>
                    </Border>
                    <Border Background="{DynamicResource PanelBg}" Padding="12,8"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="{Binding DetailMetadata}" Foreground="{DynamicResource PrimaryText}"
                                   FontSize="11" TextWrapping="Wrap" LineHeight="18"/>
                    </Border>
                    
                    <!-- Fields -->
                    <Border Background="{DynamicResource FieldBg}" Padding="12,8" Margin="0,1,0,0"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <TextBlock Text="FIELDS" FontSize="10" FontWeight="SemiBold" Foreground="{DynamicResource Accent}"/>
                    </Border>
                    <Border Padding="12,8" Margin="0,0,0,1"
                            Background="{DynamicResource FieldBg}"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                            Visibility="{Binding DetailAccessError, Converter={StaticResource BoolToVis}}">
                        <TextBlock FontSize="11" TextWrapping="Wrap" LineHeight="18"
                                   Foreground="{DynamicResource Accent}">
                            Could not load fields â€” this item may not be accessible with your current connection.
                            Click &#x21BB; to rebuild your cache from your own database.
                        </TextBlock>
                    </Border>
                    <ItemsControl ItemsSource="{Binding DetailFields}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="12,6" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="{DynamicResource PanelBg}"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="{DynamicResource FieldBg}"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding TypeIcon}" FontSize="10" FontWeight="Bold"
                                                   VerticalAlignment="Top" Margin="0,2,8,0" Foreground="{DynamicResource SecondaryText}"
                                                   FontFamily="Consolas" MinWidth="24"/>
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="{Binding AliasName}" Foreground="{DynamicResource PrimaryText}"
                                                       FontSize="12" FontWeight="SemiBold" ToolTip="{Binding Name}"/>
                                            <TextBlock Text="{Binding FieldSummary}" Foreground="{DynamicResource SecondaryText}" FontSize="10"/>
                                            <!-- Domain info: simple text for Range domains, collapsible for Coded Value -->
                                            <TextBlock Text="{Binding DomainInfo}" Foreground="{DynamicResource AccentLight}"
                                                       FontSize="10" TextWrapping="Wrap" Margin="0,2,0,0"
                                                       Visibility="{Binding HasDomain, Converter={StaticResource BoolToVis}}"/>
                                            <!-- Collapsible domain codes/values list -->
                                            <Expander IsExpanded="False" Margin="0,3,0,0"
                                                      Visibility="{Binding HasDomainValues, Converter={StaticResource BoolToVis}}">
                                                <Expander.Header>
                                                    <TextBlock Text="Domain Codes" FontSize="10" FontWeight="SemiBold"
                                                               Foreground="{DynamicResource Accent}"/>
                                                </Expander.Header>
                                                <Border Background="{DynamicResource FieldBg}" CornerRadius="3" Padding="6,4" Margin="0,4,0,0">
                                                    <ItemsControl ItemsSource="{Binding DomainValues}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Grid Margin="0,1">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto" MinWidth="50"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>
                                                                    <TextBlock Grid.Column="0" Text="{Binding Code}" FontSize="10"
                                                                               FontFamily="Consolas" Foreground="{DynamicResource Accent}"
                                                                               Margin="0,0,10,0" VerticalAlignment="Top"/>
                                                                    <TextBlock Grid.Column="1" Text="{Binding Value}" FontSize="10"
                                                                               Foreground="{DynamicResource PrimaryText}" TextWrapping="Wrap"/>
                                                                </Grid>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </Border>
                                            </Expander>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- â•â•â• STATUS BAR â•â•â• -->
        <Border Grid.Row="7" Background="{DynamicResource FieldBg}" Padding="12,6"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding StatusText}" FontSize="11"
                           Foreground="{DynamicResource SecondaryText}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                <Button Grid.Column="1" Command="{Binding ShowSeedCacheInfoCommand}"
                        Style="{StaticResource SecBtn}" Padding="6,2" Margin="6,0,0,0"
                        Visibility="{Binding IsUsingSeedCache, Converter={StaticResource BoolToVis}}"
                        ToolTip="View seed cache information">
                    <TextBlock Text="â„¹" FontSize="12" Foreground="{DynamicResource Accent}"/>
                </Button>
                <TextBlock Grid.Column="2" FontSize="11" Foreground="{DynamicResource AccentLight}" VerticalAlignment="Center" Margin="8,0,0,0">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="{Binding ResultCount, StringFormat='{}{0} items'}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ResultCount}" Value="0"><Setter Property="Visibility" Value="Collapsed"/></DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</UserControl>
